<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>CONFIGURADOR SAVIA</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&display=swap');

        :root {
            --accent: #CADEFF; 
            --accent-yellow: #FFFEA2; /* El nuevo color solicitado */
            --bg: #222222; 
            --glass-bg: rgba(0, 0, 0, 0.6);
            --glass-border: rgba(255, 255, 255, 0.3);
            --text-main: #ffffff;
            --text-dim: #cccccc;
        }

        body { 
            margin: 0; overflow: hidden; 
            background: var(--bg); 
            font-family: 'Roboto Mono', monospace; 
            color: var(--text-main); 
            user-select: none; 
        }

        /* --- CONTROLES IZQUIERDOS --- */
        #left-controls { 
            position: fixed; 
            top: 30px; 
            left: 40px; 
            display: flex; 
            flex-direction: column; 
            gap: 15px; 
            z-index: 80; 
            align-items: flex-start; /* Vuelve a alinearse a la izquierda como al inicio */
        }

        /* REVERTIDO: Estilo original del botón deshacer */
        #btn-undo { 
            width: 80px; 
            height: auto; 
            cursor: pointer; 
            pointer-events: auto; 
            transition: transform 0.2s; 
            opacity: 1; 
            object-fit: contain; 
            margin-bottom: 5px;
        }
        #btn-undo:hover { transform: scale(1.05); opacity: 0.8; }
        
        /* Botones de acción */
        .btn-action { 
            background: rgba(0,0,0,0.6); /* Fondo semi transparente para legibilidad */
            backdrop-filter: blur(4px);
            border: 1px solid white; 
            color: white; 
            padding: 12px 15px; 
            font-family: 'Roboto Mono'; 
            font-size: 10px; 
            font-weight: bold; 
            cursor: pointer; 
            text-transform: uppercase; 
            transition: all 0.2s; 
            width: 140px; 
            text-align: center;
            letter-spacing: 1px;
        }

        .btn-action:hover { 
            background: white; 
            color: black; 
        }

        .btn-action.active { 
            background: var(--accent); 
            color: black; 
            border-color: var(--accent);
            box-shadow: 0 0 15px rgba(202, 222, 255, 0.4); 
        }

        #btn-clear { border-color: rgba(255,255,255,0.5); color: rgba(255,255,255,0.7); }
        #btn-clear:hover { background: white; color: black; border-color: white; }

        /* --- DERECHA --- */
        #btn-finish { 
            position: fixed; top: 30px; right: 40px; 
            background: white; color: black; 
            border: none; padding: 12px 25px; 
            font-family: 'Roboto Mono'; font-weight: bold; font-size: 11px; letter-spacing: 1px;
            cursor: pointer; z-index: 80; transition: transform 0.2s; 
        }
        #btn-finish:hover { transform: scale(1.05); background: var(--accent); box-shadow: 0 0 15px var(--accent); }

        /* --- MEDIDAS --- */
        #medidas-container { 
            position: fixed; top: 90px; right: 40px; 
            border: 1px solid var(--glass-border); 
            color: white; padding: 15px; z-index: 10; font-size: 11px; 
            pointer-events: none; display: flex; flex-direction: column; gap: 5px; min-width: 120px; 
            background: rgba(0,0,0,0.6); backdrop-filter: blur(5px); 
        }
        .medida-row { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 4px; margin-bottom: 4px;}
        .medida-row:last-child { border-bottom: none; margin-bottom: 0; }
        
        /* APLICACIÓN DE COLOR AMARILLO FFFEA2 */
        .medida-val { font-weight: 700; color: var(--accent-yellow); }

        /* --- MODAL GENERAL Y MODAL DE SUPERFICIE --- */
        .modal-overlay-bg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); backdrop-filter: blur(8px); 
            z-index: 200; display: none; justify-content: center; align-items: center; 
        }

        /* Estilo compartido de tarjetas modales */
        .modal-card-style { 
            background: #111; border: 1px solid white; padding: 30px; 
            display: flex; flex-direction: column; align-items: center; 
            box-shadow: 0 0 30px rgba(0,0,0,0.8);
        }

        /* Modal Screenshot */
        #modal-card { width: 500px; max-height: 90vh; }
        #modal-title { font-size: 20px; letter-spacing: 4px; margin-bottom: 25px; border-bottom: 1px solid #333; width: 100%; text-align: center; padding-bottom: 15px; color: var(--accent); }
        #screenshot-img { width: 100%; height: auto; object-fit: contain; background: #222; border: 1px solid #333; margin-bottom: 25px; }
        .modal-btn-row { display: flex; gap: 15px; width: 100%; }
        .modal-btn { flex: 1; padding: 15px 0; border: none; font-weight: bold; cursor: pointer; font-family: 'Roboto Mono'; font-size: 11px; text-transform: uppercase; transition: all 0.2s; letter-spacing: 1px; }
        #btn-close-modal { background: white; color: black; } #btn-close-modal:hover { background: var(--accent); }
        #btn-export-dummy { background: #333; color: #666; cursor: not-allowed; border: 1px solid #444; }

        /* --- MODAL ESPECÍFICO DE SUPERFICIE (NUEVO UI INTEGRADO) --- */
        #surface-card { width: 300px; }
        .surface-input-group { width: 100%; margin-bottom: 20px; }
        .surface-label { display: block; font-size: 10px; color: #888; margin-bottom: 5px; letter-spacing: 1px; }
        .surface-input { 
            width: 100%; box-sizing: border-box; 
            background: transparent; border: 1px solid #555; 
            color: white; padding: 10px; font-family: 'Roboto Mono'; font-size: 14px; outline: none; text-align: center;
        }
        .surface-input:focus { border-color: var(--accent-yellow); } /* Foco Amarillo */
        
        #btn-create-surface-confirm { background: white; color: black; margin-bottom: 10px; width: 100%; padding: 12px 0; border: none; font-weight: bold; cursor: pointer; font-family: 'Roboto Mono'; }
        #btn-create-surface-confirm:hover { background: var(--accent-yellow); }
        #btn-cancel-surface { background: transparent; color: #888; width: 100%; padding: 8px 0; border: 1px solid transparent; cursor: pointer; font-family: 'Roboto Mono'; font-size: 10px; }
        #btn-cancel-surface:hover { color: white; }


        /* --- UI PANEL INFERIOR --- */
        #header-container { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); pointer-events: none; z-index: 10; }
        h1.logo-text { font-size: 16px; letter-spacing: 6px; color: white; margin: 0; text-transform: uppercase; opacity: 1; text-shadow: 0 0 10px rgba(0,0,0,0.5); }
        
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: flex; flex-direction: column; justify-content: flex-end; }
        
        #panel-inferior { 
            pointer-events: auto; 
            width: 100%; 
            height: 220px; 
            background: var(--glass-bg); 
            backdrop-filter: blur(10px); 
            border-top: 1px solid white; 
            display: flex; 
            flex-direction: column; 
            transform: translateY(100%); 
            transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1); 
        }
        #panel-inferior.visible { transform: translateY(0); }
        
        #tabs-container { display: flex; background: rgba(0,0,0,0.2); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tab-btn { background: transparent; border-right: 1px solid rgba(255,255,255,0.1); color: var(--text-dim); padding: 15px 30px; font-size: 11px; font-weight: bold; text-transform: uppercase; cursor: pointer; transition: all 0.2s; letter-spacing: 1px; }
        .tab-btn:hover { background: rgba(255,255,255,0.05); color: white; }
        .tab-btn.active { background: rgba(255,255,255,0.1); color: var(--accent); border-bottom: 2px solid var(--accent); }
        .tab-btn.disabled { display: none; }
        
        #grid-container { padding: 25px 40px; flex-grow: 1; display: flex; gap: 25px; overflow-x: auto; align-items: center; }
        #grid-container::-webkit-scrollbar { height: 4px; } #grid-container::-webkit-scrollbar-track { background: transparent; } #grid-container::-webkit-scrollbar-thumb { background: #555; }
        
        .item-card { width: 130px; height: 130px; background: rgba(0,0,0,0.4); border: 1px solid #444; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: all 0.2s; flex-shrink: 0; }
        .item-card:hover { border-color: white; background: rgba(255,255,255,0.05); }
        .item-card.selected { border: 1px solid var(--accent); box-shadow: 0 0 15px rgba(202, 222, 255, 0.15); background: rgba(202, 222, 255, 0.05); }
        .item-image { width: 85%; height: 65%; object-fit: contain; margin-bottom: 8px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6)); transition: transform 0.2s;}
        .item-card:hover .item-image { transform: scale(1.05); }
        .item-placeholder { width: 50px; height: 50px; border: 1px solid #666; margin-bottom: 10px; }
        .item-name { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; color: #ccc; margin-top: 5px; }
        
        #btn-confirmar { position: absolute; top: -45px; right: 0; height: 45px; padding: 0 40px; background: var(--accent); color: black; border: none; font-weight: bold; font-size: 12px; letter-spacing: 2px; cursor: pointer; display: none; pointer-events: auto; }
        #btn-confirmar.visible { display: block; } #btn-confirmar:hover { background: white; }
        
        /* --- REPETIR CONTROL --- */
        #repeat-container {
            position: absolute; top: -45px; right: 220px; height: 45px;
            display: none; align-items: center; background: rgba(0,0,0,0.9); border: 1px solid #fff;
            pointer-events: auto;
        }
        #repeat-container.visible { display: flex; }
        .btn-qty { width: 45px; height: 100%; border: none; background: transparent; color: white; font-size: 18px; font-weight: bold; cursor: pointer; transition: background 0.2s;}
        .btn-qty:hover { background: #333; color: var(--accent); }
        #qty-val { min-width: 45px; text-align: center; font-size: 14px; font-weight: bold; color: var(--accent); }

        #loader { position: absolute; top:50%; left:50%; transform:translate(-50%,-50%); font-size: 10px; letter-spacing: 3px; }
    </style>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div id="loader">CARGANDO...</div>
    <div id="header-container"><h1 class="logo-text">CONFIGURADOR SAVIA</h1></div>

    <div id="left-controls">
        <img id="btn-undo" src="deshacer.png" alt="Deshacer" title="Deshacer">
        <button id="btn-new-group" class="btn-action">NUEVO GRUPO</button>
        <button id="btn-move" class="btn-action">MOVER PIEZA</button>
        <button id="btn-surface" class="btn-action">CREAR PISO</button>
        <button id="btn-clear" class="btn-action">REINICIAR</button>
    </div>

    <button id="btn-finish">FINALIZAR</button>

    <div id="medidas-container">
        <div class="medida-row"><span style="color:#aaa">ANCHO</span><span id="val-ancho" class="medida-val">0.00 m</span></div>
        <div class="medida-row"><span style="color:#aaa">LARGO</span><span id="val-largo" class="medida-val">0.00 m</span></div>
        <div class="medida-row"><span style="color:#aaa">ALTO</span><span id="val-alto" class="medida-val">0.00 m</span></div>
    </div>

    <div id="modal-overlay" class="modal-overlay-bg">
        <div id="modal-card" class="modal-card-style">
            <div id="modal-title">TU CONFIGURACIÓN</div>
            <img id="screenshot-img" src="" alt="Tu Diseño">
            <div class="modal-btn-row">
                <button id="btn-close-modal" class="modal-btn">SEGUIR EDITANDO</button>
                <button id="btn-export-dummy" class="modal-btn">EXPORTAR PDF</button>
            </div>
        </div>
    </div>

    <div id="surface-modal-overlay" class="modal-overlay-bg">
        <div id="surface-card" class="modal-card-style">
            <div id="modal-title">DEFINIR SUPERFICIE</div>
            
            <div class="surface-input-group">
                <label class="surface-label">ANCHO (Metros)</label>
                <input type="number" id="input-surf-width" class="surface-input" value="4" step="0.5" min="1">
            </div>

            <div class="surface-input-group">
                <label class="surface-label">LARGO (Metros)</label>
                <input type="number" id="input-surf-length" class="surface-input" value="4" step="0.5" min="1">
            </div>

            <button id="btn-create-surface-confirm">CREAR SUPERFICIE</button>
            <button id="btn-cancel-surface">CANCELAR</button>
        </div>
    </div>

    <div id="ui-layer">
        <div id="panel-inferior">
            
            <div id="repeat-container">
                <button class="btn-qty" id="btn-minus">-</button>
                <span id="qty-val">1</span>
                <button class="btn-qty" id="btn-plus">+</button>
            </div>

            <button id="btn-confirmar">CONFIRMAR</button>
            <div id="tabs-container"></div>
            <div id="grid-container"></div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { TransformControls } from 'three/addons/controls/TransformControls.js';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { RGBELoader } from 'three/addons/loaders/RGBELoader.js';

        const RUTA_BASE = "piezas/";
        
        const CATALOGO = {
            "mobiliario": {
                label: "MOBILIARIO",
                folder: "mobiliario/",
                type: "static",
                items: [
                    { name: "ISQUIO", file: "isquio.glb", img: "ISQUIAL.png" },
                    { name: "ISQUIO XL", file: "isquioxl.glb", img: "ISQUIALMÚLTIPLE.png" },
                    { name: "BANCO", file: "banco.glb", img: "BANCO.png", fixRot: { z: 90 } },
                    { name: "BANCO RESP.", file: "bancorespaldo.glb", img: "BANCORESPALDO.png" },
                    { name: "BANCO XL", file: "bancoxl.glb", img: "BANCOMÚLTIPLE.png" },
                    { name: "BARRA", file: "barra.glb", img: "BARRA.png" },
                    { name: "CENICERO", file: "cenicero.glb", img: "CENICERO.png" },
                    { name: "MESA", file: "mesa.glb", img: "MESA.png" },
                    { name: "MESA XL", file: "mesaxl.glb", img: "MESAMÚLTIPLE.png" }
                ]
            },
            "configuraciones": {
                label: "CONFIGURACIONES",
                folder: "configuraciones/",
                type: "static",
                items: [
                    { name: "ALMUERZO", file: "almuerzo.glb", img: "ALMUERZO.png" },
                    { name: "RECREO", file: "recreo.glb", img: "RECREO.png" },
                    { name: "MESA SIMPLE", file: "mesasimple.glb", img: "SOLO.png" }
                ]
            },
            "bosques": {
                label: "BOSQUES",
                folder: "bosques/",
                type: "static",
                items: [
                    { name: "BOSQUE MINI", file: "bosque.glb", img: "BOSQUE.png" },
                    { name: "BOSQUE MID", file: "bosquemid.glb", img: "BOSQUEMID.png" },
                    { name: "BOSQUE MAX", file: "bosquemax.glb", img: "BOSQUEMAX.png" }
                ]
            },
            "canos": {
                label: "MÓDULOS VERDES",
                folder: "canos/",
                type: "smart",
                items: [ { name: "MODULO", file: "tubo_50_recto.glb", id: "recto", img: "CANO.png" } ]
            }
        };

        const ARCHIVOS_SMART = { recto: "tubo_50_recto.glb", c45: "tubo_50_codo45.glb", c90: "tubo_50_codo90.glb" };

        let categoriaActiva = "mobiliario"; 
        let itemActivo = CATALOGO["mobiliario"].items[0]; 

        let scene, camera, renderer, orbit, gizmo;
        let isPlacing = false;
        let isDraggingNewGroup = false;
        let isMoveMode = false;
        let isValidPlacement = true; 
        
        let pivotPadre = new THREE.Object3D();      
        let simuladorRotacion = new THREE.Object3D(); 
        let visualAxes = new THREE.AxesHelper(0.6);
        let gridHelper, plane;
        
        let puntoPartida = null; 
        
        let piezaPreview = null; 
        let previewBaseModel = null; 
        let cantidadRepeticiones = 1;
        let offsetZ = 0.5; 
        let archivoCargadoActual = ""; 
        
        let botones = [];
        let raycaster = new THREE.Raycaster();
        let mouse = new THREE.Vector2();
        
        const historialPiezas = [];
        let piezaBase = null;

        let superficiePersonalizada = null;

        const loader = new GLTFLoader();
        const texLoader = new THREE.TextureLoader();
        const iconMas = texLoader.load('mas.png'); 
        const rgbeLoader = new RGBELoader();

        let rotacionConectorOriginal = new THREE.Quaternion();

        init();

        function init() {
            crearInterfaz();

            scene = new THREE.Scene();
            scene.background = new THREE.Color(0x222222); 
            scene.fog = new THREE.FogExp2(0x222222, 0.02); 

            rgbeLoader.load('https://raw.githubusercontent.com/mrdoob/three.js/master/examples/textures/equirectangular/royal_esplanade_1k.hdr', function (texture) {
                texture.mapping = THREE.EquirectangularReflectionMapping;
                scene.environment = texture;
            });

            gridHelper = new THREE.GridHelper(2000, 4000, 0x555555, 0x333333);
            gridHelper.position.y = -0.01; scene.add(gridHelper);
            
            plane = new THREE.Mesh(new THREE.PlaneGeometry(4000, 4000), new THREE.MeshBasicMaterial({ color: 0x222222 }));
            plane.rotation.x = -Math.PI / 2;
            plane.position.y = -0.02;
            scene.add(plane);

            const ambient = new THREE.AmbientLight(0xffffff, 1.8); 
            scene.add(ambient);

            const hemi = new THREE.HemisphereLight(0xffffff, 0xbbbbbb, 0.6); 
            scene.add(hemi);

            const mainLight = new THREE.DirectionalLight(0xffffff, 0.8); 
            mainLight.position.set(5, 10, 5);
            mainLight.castShadow = true;
            mainLight.shadow.bias = -0.001;
            scene.add(mainLight);

            const fillLight = new THREE.DirectionalLight(0xffffff, 1.2); 
            fillLight.position.set(-5, 5, -5);
            scene.add(fillLight);

            camera = new THREE.PerspectiveCamera(45, window.innerWidth/window.innerHeight, 0.1, 3000);
            camera.position.set(4, 3, 4);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, preserveDrawingBuffer: true }); 
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.shadowMap.enabled = true;
            renderer.toneMapping = THREE.ACESFilmicToneMapping;
            renderer.toneMappingExposure = 1.0; 
            document.body.appendChild(renderer.domElement);

            orbit = new OrbitControls(camera, renderer.domElement);
            orbit.enableDamping = true;
            orbit.maxPolarAngle = Math.PI / 2 - 0.05; 

            gizmo = new TransformControls(camera, renderer.domElement);
            gizmo.setMode('rotate'); 
            gizmo.setSpace('local'); 
            gizmo.setRotationSnap(Math.PI / 4); 
            gizmo.size = 1.0;
            
            gizmo.showX = true; gizmo.showY = true; gizmo.showZ = false; 
            
            gizmo.addEventListener('dragging-changed', e => orbit.enabled = !e.value);
            gizmo.addEventListener('change', procesarRotacion);
            scene.add(gizmo);

            setTimeout(() => {
                const cadeffColor = new THREE.Color(0xCADEFF);
                gizmo.traverse(child => {
                    if (child.isMesh || child.isLine) {
                        if (child.name === 'E') child.visible = false;
                        if (['X', 'Y', 'Z'].includes(child.name)) {
                            if (child.material) {
                                child.material = child.material.clone();
                                child.material.color.copy(cadeffColor);
                                child.material.vertexColors = false;
                                child.material.opacity = 1;
                                child.material.transparent = false;
                                child.material.depthTest = false;
                                child.material.depthWrite = false;
                            }
                        }
                        if (child.name.length > 1) child.visible = false;
                    }
                });
                renderer.render(scene, camera);
            }, 100);

            pivotPadre.add(simuladorRotacion);
            pivotPadre.add(visualAxes); 

            crearPuntoDePartida();

            window.addEventListener('resize', onResize);
            window.addEventListener('pointerdown', onClick);
            window.addEventListener('mousemove', onMouseMove);
            
            document.getElementById('btn-confirmar').onclick = () => confirmarPieza();
            document.getElementById('btn-plus').onclick = () => cambiarRepeticion(1);
            document.getElementById('btn-minus').onclick = () => cambiarRepeticion(-1);
            
            document.getElementById('btn-new-group').onclick = iniciarNuevoGrupo;
            document.getElementById('btn-move').onclick = toggleModoMover;
            
            // --- NUEVOS LISTENERS PARA SUPERFICIE ---
            document.getElementById('btn-surface').onclick = abrirModalSuperficie;
            document.getElementById('btn-create-surface-confirm').onclick = confirmarCreacionSuperficie;
            document.getElementById('btn-cancel-surface').onclick = cerrarModalSuperficie;

            document.getElementById('loader').style.display = 'none';
            
            animate();
        }

        // --- LÓGICA DE SUPERFICIE CON UI INTEGRADA ---
        
        function abrirModalSuperficie() {
            document.getElementById('surface-modal-overlay').style.display = 'flex';
        }

        function cerrarModalSuperficie() {
            document.getElementById('surface-modal-overlay').style.display = 'none';
        }

        function confirmarCreacionSuperficie() {
            const anchoInput = document.getElementById('input-surf-width').value;
            const largoInput = document.getElementById('input-surf-length').value;
            
            const ancho = parseFloat(anchoInput);
            const largo = parseFloat(largoInput);

            if (isNaN(ancho) || isNaN(largo) || ancho <= 0 || largo <= 0) {
                alert("Por favor, ingrese valores válidos.");
                return;
            }

            if (superficiePersonalizada) {
                scene.remove(superficiePersonalizada);
                if (superficiePersonalizada.geometry) superficiePersonalizada.geometry.dispose();
                if (superficiePersonalizada.material) superficiePersonalizada.material.dispose();
            }

            const geometry = new THREE.PlaneGeometry(ancho, largo);
            const material = new THREE.MeshStandardMaterial({ 
                color: 0x555555, // Gris claro
                roughness: 0.9, 
                metalness: 0.05 
            });
            
            superficiePersonalizada = new THREE.Mesh(geometry, material);
            superficiePersonalizada.rotation.x = -Math.PI / 2;
            superficiePersonalizada.position.y = -0.005; 
            superficiePersonalizada.receiveShadow = true;
            
            scene.add(superficiePersonalizada);
            
            cerrarModalSuperficie();
        }

        function toggleModoMover() {
            if(isPlacing) return;
            isMoveMode = !isMoveMode;
            const btn = document.getElementById('btn-move');
            const btnNew = document.getElementById('btn-new-group');
            
            if(isMoveMode) {
                btn.classList.add('active');
                btnNew.classList.remove('active');
                document.body.style.cursor = 'crosshair';
            } else {
                btn.classList.remove('active');
                document.body.style.cursor = 'default';
            }
        }

        function iniciarNuevoGrupo() {
            if(isPlacing) return;
            isMoveMode = false;
            document.getElementById('btn-move').classList.remove('active');
            document.body.style.cursor = 'default';

            isPlacing = true;
            isDraggingNewGroup = true;
            isValidPlacement = true;
            document.getElementById('btn-new-group').classList.add('active');
            document.getElementById('panel-inferior').classList.add('visible');
            document.getElementById('btn-confirmar').classList.add('visible');
            botones.forEach(b => b.visible = false);

            scene.add(pivotPadre);
            pivotPadre.position.set(0,0,0);
            pivotPadre.rotation.set(0,0,0);
            simuladorRotacion.rotation.set(0,0,0);
            
            cantidadRepeticiones = 1;
            document.getElementById('qty-val').innerText = "1";
            
            archivoCargadoActual = ""; 
            while(simuladorRotacion.children.length > 0){ simuladorRotacion.remove(simuladorRotacion.children[0]); }
            piezaPreview = null;
            previewBaseModel = null;

            gizmo.attach(simuladorRotacion);
            configurarRestricciones(); 
            
            if (CATALOGO[categoriaActiva].type === 'static') {
                cambiarModeloPreview(CATALOGO[categoriaActiva].folder, itemActivo.file);
            } else {
                cambiarModeloPreview(CATALOGO[categoriaActiva].folder, ARCHIVOS_SMART.recto);
            }
            procesarRotacion();
        }

        function recogerPieza(piezaObject) {
            let index = historialPiezas.indexOf(piezaObject);
            let esLaBase = false;
            
            if (index > -1) {
                historialPiezas.splice(index, 1);
            } else if (piezaBase === piezaObject) {
                piezaBase = null;
                esLaBase = true;
            } else {
                return; 
            }

            const botonesAElminar = [];
            botones = botones.filter(b => {
                let p = b.userData.padre;
                let pertenece = false;
                p.traverseAncestors(a => { if(a === piezaObject) pertenece = true; });
                if(pertenece) {
                    scene.remove(b); 
                    if(b.parent) b.parent.remove(b);
                    return false; 
                }
                return true;
            });

            isPlacing = true;
            isDraggingNewGroup = true; 
            isValidPlacement = true;
            isMoveMode = false; 
            document.getElementById('btn-move').classList.remove('active');
            document.body.style.cursor = 'default';

            document.getElementById('panel-inferior').classList.add('visible');
            document.getElementById('btn-confirmar').classList.add('visible');
            botones.forEach(b => b.visible = false); 

            scene.add(pivotPadre);
            pivotPadre.position.copy(piezaObject.position); 
            pivotPadre.rotation.set(0,0,0); 

            simuladorRotacion.rotation.set(0,0,0);
            
            piezaObject.position.set(0,0,0);
            piezaObject.rotation.set(0,0,0); 
            
            piezaObject.traverse(c => {
                if(c.isMesh) {
                    c.material = new THREE.MeshBasicMaterial({ color: 0xCADEFF, wireframe: true, transparent: true, opacity: 0.3 });
                }
            });

            simuladorRotacion.add(piezaObject);
            previewBaseModel = piezaObject; 
            
            if(piezaObject.userData.itemData) {
                itemActivo = piezaObject.userData.itemData;
                for(let key in CATALOGO) {
                    if(CATALOGO[key].items.includes(itemActivo)) {
                         cambiarCategoria(key);
                         break;
                    }
                }
            }
            
            archivoCargadoActual = piezaObject.userData.archivo || itemActivo.file;

            cantidadRepeticiones = 1;
            document.getElementById('qty-val').innerText = "1";

            gizmo.attach(simuladorRotacion);
            configurarRestricciones();
            verificarColisionPiso();
        }

        function onMouseMove(e) {
            if (isPlacing && isDraggingNewGroup) {
                mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
                mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                
                const intersects = raycaster.intersectObject(plane);
                
                if (intersects.length > 0) {
                    const p = intersects[0].point;
                    const snap = 0.5;
                    pivotPadre.position.set(
                        Math.round(p.x / snap) * snap,
                        0,
                        Math.round(p.z / snap) * snap
                    );
                }
            }
        }

        function cambiarRepeticion(delta) {
            let nueva = cantidadRepeticiones + delta;
            if(nueva < 1) nueva = 1;
            if(nueva > 10) nueva = 10; 
            cantidadRepeticiones = nueva;
            document.getElementById('qty-val').innerText = cantidadRepeticiones;
            actualizarGeometriaPreview();
        }

        function actualizarGeometriaPreview() {
            if (!previewBaseModel) return;
            while(simuladorRotacion.children.length > 0){ simuladorRotacion.remove(simuladorRotacion.children[0]); }
            for (let i = 0; i < cantidadRepeticiones; i++) {
                const clon = previewBaseModel.clone();
                clon.position.set(0, 0, offsetZ * i);
                simuladorRotacion.add(clon);
            }
            verificarColisionPiso();
        }

        function crearPuntoDePartida() {
            puntoPartida = new THREE.Object3D();
            puntoPartida.position.set(0, 0, 0);
            puntoPartida.rotation.set(0, 0, 0);
            scene.add(puntoPartida);

            const material = new THREE.SpriteMaterial({ map: iconMas, depthTest: false, opacity: 0.9 });
            const sprite = new THREE.Sprite(material);
            sprite.scale.set(0.3, 0.3, 0.3); 
            sprite.userData.padre = puntoPartida;
            sprite.name = "BotonInicial"; 
            
            puntoPartida.add(sprite);
            botones.push(sprite);
        }

        function crearInterfaz() {
            const tabsContainer = document.getElementById('tabs-container');
            for (const key in CATALOGO) {
                const cat = CATALOGO[key];
                const btn = document.createElement('div');
                btn.className = 'tab-btn';
                btn.dataset.key = key;
                if(key === categoriaActiva) btn.classList.add('active');
                btn.innerText = cat.label;
                btn.onclick = () => cambiarCategoria(key);
                tabsContainer.appendChild(btn);
            }
            renderizarItems();
        }

        function cambiarCategoria(key) {
            categoriaActiva = key;
            const tabs = document.querySelectorAll('.tab-btn');
            tabs.forEach(t => {
                if(t.dataset.key === key) t.classList.add('active');
                else t.classList.remove('active');
            });
            if (CATALOGO[key].items.length > 0) itemActivo = CATALOGO[key].items[0];
            renderizarItems();
            if (isPlacing) { 
                if(!isDraggingNewGroup) configurarRestricciones(); 
                procesarRotacion(); 
            }
        }

        function renderizarItems() {
            const gridContainer = document.getElementById('grid-container');
            gridContainer.innerHTML = ''; 
            const items = CATALOGO[categoriaActiva].items;
            if(items.length === 0) { gridContainer.innerHTML = '<div style="color:#666; font-size:12px; margin:auto;">PRÓXIMAMENTE</div>'; return; }

            items.forEach(item => {
                const card = document.createElement('div');
                card.className = 'item-card';
                if(item === itemActivo) card.classList.add('selected');
                
                let visualContent = item.img ? `<img src="pngs/${item.img}" class="item-image">` : `<div class="item-placeholder"></div>`;
                card.innerHTML = `${visualContent}<div class="item-name">${item.name}</div>`;

                card.onclick = () => {
                    itemActivo = item;
                    document.querySelectorAll('.item-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    
                    if(isPlacing) { 
                        if(!isDraggingNewGroup) configurarRestricciones(); 
                        procesarRotacion(); 
                    }
                };
                gridContainer.appendChild(card);
            });
        }

        function filtrarTabsPorAltura(altura) {
            const tabs = document.querySelectorAll('.tab-btn');
            const ES_AIRE = Math.abs(altura) > 0.05;
            tabs.forEach(tab => {
                const key = tab.dataset.key;
                const tipo = CATALOGO[key].type;
                if (tipo === 'static' && ES_AIRE) {
                    tab.classList.add('disabled');
                } else {
                    tab.classList.remove('disabled');
                }
            });
            const activeType = CATALOGO[categoriaActiva].type;
            if (activeType === 'static' && ES_AIRE) {
                cambiarCategoria('canos');
            }
        }

        function iniciarColocacion(padreBtn) {
            if(isPlacing) return;
            isPlacing = true;
            isDraggingNewGroup = false; 
            isValidPlacement = true;
            
            isMoveMode = false;
            document.getElementById('btn-move').classList.remove('active');
            document.body.style.cursor = 'default';

            const pos = new THREE.Vector3(); const quat = new THREE.Quaternion();
            padreBtn.getWorldPosition(pos); 
            padreBtn.getWorldQuaternion(quat);

            rotacionConectorOriginal.copy(quat);

            filtrarTabsPorAltura(pos.y);
            document.getElementById('panel-inferior').classList.add('visible');
            document.getElementById('btn-confirmar').classList.add('visible');
            botones.forEach(b => b.visible = false);

            scene.add(pivotPadre);
            pivotPadre.position.copy(pos); 
            pivotPadre.quaternion.copy(quat);

            simuladorRotacion.rotation.set(0,0,0);
            
            cantidadRepeticiones = 1;
            document.getElementById('qty-val').innerText = "1";
            
            archivoCargadoActual = ""; 
            while(simuladorRotacion.children.length > 0){ simuladorRotacion.remove(simuladorRotacion.children[0]); }
            piezaPreview = null;
            previewBaseModel = null;

            gizmo.attach(simuladorRotacion);
            configurarRestricciones(); 
            
            if (CATALOGO[categoriaActiva].type === 'smart') {
                cambiarModeloPreview(CATALOGO[categoriaActiva].folder, ARCHIVOS_SMART.recto);
            } else {
                procesarRotacion(); 
            }
        }

        function configurarRestricciones() {
            const tipo = CATALOGO[categoriaActiva].type;
            if (tipo === 'static') {
                gizmo.detach();
                pivotPadre.rotation.set(0, Math.PI, 0); 
                
                gizmo.attach(simuladorRotacion);
                gizmo.showX = false; 
                gizmo.showY = true;  
                gizmo.showZ = false; 
            } else {
                gizmo.detach();
                if(!isDraggingNewGroup) pivotPadre.quaternion.copy(rotacionConectorOriginal);
                gizmo.attach(simuladorRotacion);
                gizmo.showX = true; 
                gizmo.showY = true; 
                gizmo.showZ = true; 
            }
        }

        function procesarRotacion() {
            if(!isPlacing) return;
            
            verificarColisionPiso();

            const tipo = CATALOGO[categoriaActiva].type;
            const folder = RUTA_BASE + CATALOGO[categoriaActiva].folder;
            let archivo = "";

            if (tipo === 'static') { 
                archivo = itemActivo.file;
                document.getElementById('repeat-container').style.display = 'none'; 
            } else {
                const rot = simuladorRotacion.rotation; const deg = 180/Math.PI;
                const angX = Math.abs(rot.x * deg) % 360;
                const angY = Math.abs(rot.y * deg) % 360;
                const maxAng = Math.max(angX, angY);
                
                if (maxAng < 20 || (maxAng > 160 && maxAng < 200)) {
                    archivo = ARCHIVOS_SMART.recto;
                    document.getElementById('repeat-container').style.display = 'flex';
                } else {
                    if (maxAng > 20 && maxAng < 70) archivo = ARCHIVOS_SMART.c45;
                    else archivo = ARCHIVOS_SMART.c90;
                    document.getElementById('repeat-container').style.display = 'none';
                    if (cantidadRepeticiones > 1) {
                        cantidadRepeticiones = 1;
                        document.getElementById('qty-val').innerText = "1";
                    }
                }
            }
            if (archivoCargadoActual !== archivo) cambiarModeloPreview(folder, archivo);
            else if (archivoCargadoActual === ARCHIVOS_SMART.recto) {
                actualizarGeometriaPreview();
            }
        }

        function verificarColisionPiso() {
            if(!simuladorRotacion) return;
            simuladorRotacion.updateMatrixWorld(true);
            const box = new THREE.Box3().setFromObject(simuladorRotacion);
            
            if (box.min.y < -0.1) {
                isValidPlacement = false;
                document.getElementById('btn-confirmar').style.display = 'none';
                
                simuladorRotacion.traverse(c => { 
                    if(c.material) c.material.color.set(0xff0000); 
                });
            } else {
                isValidPlacement = true;
                document.getElementById('btn-confirmar').style.display = 'block';
                
                simuladorRotacion.traverse(c => { 
                    if(c.material) c.material.color.set(0xCADEFF); 
                });
            }
        }

        function cambiarModeloPreview(folder, archivo) {
            archivoCargadoActual = archivo;
            loader.load(folder + archivo, (gltf) => {
                
                offsetZ = 0.5; 
                gltf.scene.traverse(c => {
                    if(c.name.toLowerCase().includes('conector')) {
                        offsetZ = c.position.length();
                    }
                });

                previewBaseModel = gltf.scene; 
                previewBaseModel.position.set(0,0,0); 
                previewBaseModel.rotation.set(0,0,0);
                
                if (itemActivo.fixRot) {
                    if (itemActivo.fixRot.x) previewBaseModel.rotateX(THREE.MathUtils.degToRad(itemActivo.fixRot.x));
                    if (itemActivo.fixRot.y) previewBaseModel.rotateY(THREE.MathUtils.degToRad(itemActivo.fixRot.y));
                    if (itemActivo.fixRot.z) previewBaseModel.rotateZ(THREE.MathUtils.degToRad(itemActivo.fixRot.z));
                }

                previewBaseModel.traverse(c => {
                    if(c.isMesh) {
                        c.material = new THREE.MeshBasicMaterial({ color: 0xCADEFF, wireframe: true, transparent: true, opacity: 0.3 });
                    }
                });

                actualizarGeometriaPreview();
            });
        }

        function confirmarPieza() {
            if(!previewBaseModel || !isValidPlacement) return; 
            
            const folder = RUTA_BASE + CATALOGO[categoriaActiva].folder;
            const fixRot = itemActivo.fixRot || null;

            const startPos = new THREE.Vector3();
            const startQuat = new THREE.Quaternion();
            pivotPadre.getWorldPosition(startPos);
            pivotPadre.getWorldQuaternion(startQuat);

            const vecLocal = new THREE.Vector3(0,0,offsetZ);
            const rotFinal = new THREE.Quaternion();
            rotFinal.multiplyQuaternions(pivotPadre.quaternion, simuladorRotacion.quaternion);
            const vecMundo = vecLocal.clone().applyQuaternion(rotFinal);

            for(let i=0; i<cantidadRepeticiones; i++) {
                const nuevaPos = startPos.clone().add(vecMundo.clone().multiplyScalar(i));
                cargarPiezaBase(folder, archivoCargadoActual, nuevaPos, rotFinal, fixRot, false);
            }

            gizmo.detach(); scene.remove(pivotPadre);
            
            isPlacing = false;
            isDraggingNewGroup = false;
            document.body.style.cursor = 'default';
            document.getElementById('btn-new-group').classList.remove('active');
            
            document.getElementById('panel-inferior').classList.remove('visible'); 
            document.getElementById('btn-confirmar').classList.remove('visible');
            document.getElementById('repeat-container').style.display = 'none';
            botones.forEach(b => b.visible = true);
        }

        function cargarPiezaBase(folder, archivo, pos, quat, fixRot = null, esLaBase = false) {
            if (puntoPartida) {
                scene.remove(puntoPartida);
                botones = botones.filter(b => b.name !== "BotonInicial");
                puntoPartida = null;
            }

            loader.load(folder + archivo, (gltf) => {
                const m = gltf.scene; m.position.copy(pos); m.quaternion.copy(quat);
                
                if (fixRot) {
                    if (fixRot.x) m.rotateX(THREE.MathUtils.degToRad(fixRot.x));
                    if (fixRot.y) m.rotateY(THREE.MathUtils.degToRad(fixRot.y));
                    if (fixRot.z) m.rotateZ(THREE.MathUtils.degToRad(fixRot.z));
                }

                m.traverse(c => { if(c.isMesh) { c.castShadow = true; c.receiveShadow = true; } });

                m.userData.itemData = itemActivo;
                m.userData.archivo = archivo;

                scene.add(m);
                if (esLaBase) piezaBase = m; else historialPiezas.push(m);
                generarBotones(m);
                actualizarMedidas();
            });
        }

        function generarBotones(modelo) {
            modelo.traverse(c => {
                if(c.name.toLowerCase().includes('conector')) {
                    const sp = new THREE.Sprite(new THREE.SpriteMaterial({map:iconMas, depthTest:false, transparent:true, opacity:0.8}));
                    sp.scale.set(0.15,0.15,0.15); sp.userData.padre = c; c.add(sp); botones.push(sp);
                }
            });
        }

        function actualizarMedidas() {
            const box = new THREE.Box3();
            if (piezaBase) box.expandByObject(piezaBase);
            historialPiezas.forEach(p => box.expandByObject(p));
            if (box.isEmpty()) {
                document.getElementById('val-ancho').innerText = "0.00 m";
                document.getElementById('val-largo').innerText = "0.00 m";
                document.getElementById('val-alto').innerText = "0.00 m";
                return;
            }
            const size = new THREE.Vector3(); box.getSize(size);
            document.getElementById('val-ancho').innerText = size.x.toFixed(2) + " m";
            document.getElementById('val-alto').innerText = size.y.toFixed(2) + " m";
            document.getElementById('val-largo').innerText = size.z.toFixed(2) + " m";
        }

        function onClick(e) {
            if(isPlacing && isDraggingNewGroup) {
                isDraggingNewGroup = false;
                document.body.style.cursor = 'default';
                document.getElementById('btn-confirmar').classList.add('visible');
                verificarColisionPiso();
                return;
            }

            if(isMoveMode && !isPlacing) {
                if(e.target.closest('#left-controls') || e.target.closest('#panel-inferior')) return;
                
                mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
                raycaster.setFromCamera(mouse, camera);
                
                const candidatos = [...historialPiezas];
                if(piezaBase) candidatos.push(piezaBase);
                
                const intersects = raycaster.intersectObjects(candidatos, true);
                if(intersects.length > 0) {
                    let root = intersects[0].object;
                    while(root.parent && root.parent !== scene) {
                        root = root.parent;
                    }
                    if(root) recogerPieza(root);
                }
                return;
            }

            if(isPlacing) return; 
            if(e.target.closest('#panel-inferior') || e.target.closest('#left-controls') || e.target.id === 'btn-finish') return;
            if(e.target.closest('#repeat-container') || e.target.closest('#surface-card')) return;

            mouse.x = (e.clientX / window.innerWidth) * 2 - 1; mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
            raycaster.setFromCamera(mouse, camera);
            const intersects = raycaster.intersectObjects(botones.filter(b=>b.visible));
            if(intersects.length > 0) iniciarColocacion(intersects[0].object.userData.padre);
        }

        document.getElementById('btn-undo').onclick = () => {
            if (isPlacing) {
                isPlacing = false; isDraggingNewGroup = false;
                document.body.style.cursor = 'default';
                document.getElementById('btn-new-group').classList.remove('active');
                gizmo.detach(); scene.remove(pivotPadre);
                if(piezaPreview) simuladorRotacion.remove(piezaPreview);
                document.getElementById('panel-inferior').classList.remove('visible');
                document.getElementById('btn-confirmar').classList.remove('visible');
                document.getElementById('repeat-container').style.display = 'none';
                botones.forEach(b => b.visible = true);
                
                if (historialPiezas.length === 0 && !piezaBase) {
                    if(!puntoPartida) crearPuntoDePartida();
                }
                return;
            }
            if (historialPiezas.length > 0) {
                const ultima = historialPiezas.pop(); scene.remove(ultima);
                botones = []; scene.traverse(obj => { if (obj.isSprite && obj.name === "BotonAgregar") obj.parent.remove(obj); });
                let piezaAnterior = (historialPiezas.length > 0) ? historialPiezas[historialPiezas.length - 1] : piezaBase;
                if (piezaAnterior) generarBotones(piezaAnterior);
                actualizarMedidas();
            } else if (piezaBase) {
                scene.remove(piezaBase);
                piezaBase = null;
                botones = [];
                crearPuntoDePartida();
                actualizarMedidas();
            }
        };

        document.getElementById('btn-clear').onclick = () => {
            if(confirm("¿Reiniciar todo el diseño?")) {
                if(piezaBase) scene.remove(piezaBase);
                historialPiezas.forEach(p => scene.remove(p));
                historialPiezas.length = 0;
                piezaBase = null;
                botones = [];
                scene.traverse(obj => { if (obj.isSprite && obj.name === "BotonAgregar") obj.parent.remove(obj); });
                if (puntoPartida) scene.remove(puntoPartida);
                
                if(superficiePersonalizada) {
                    scene.remove(superficiePersonalizada);
                    superficiePersonalizada = null;
                }

                crearPuntoDePartida();
                document.getElementById('panel-inferior').classList.remove('visible');
                actualizarMedidas();
            }
        };

        document.getElementById('btn-finish').onclick = () => {
            gizmo.visible = false;
            gridHelper.visible = false;
            plane.visible = false;
            botones.forEach(b => b.visible = false);
            const currentCamPos = camera.position.clone();
            const currentTarget = orbit.target.clone();
            if (piezaBase || historialPiezas.length > 0) {
                const box = new THREE.Box3();
                if(piezaBase) box.expandByObject(piezaBase);
                historialPiezas.forEach(p => box.expandByObject(p));
                if(superficiePersonalizada) box.expandByObject(superficiePersonalizada);

                const center = new THREE.Vector3(); box.getCenter(center);
                const size = new THREE.Vector3(); box.getSize(size);
                const maxDim = Math.max(size.x, size.y, size.z);
                const fov = camera.fov * (Math.PI / 180);
                let cameraDist = Math.abs(maxDim / 2 / Math.tan(fov / 2)) * 1.5;
                camera.position.set(center.x + cameraDist, center.y + cameraDist*0.8, center.z + cameraDist);
                orbit.target.copy(center);
                camera.updateProjectionMatrix();
                orbit.update();
            }
            renderer.render(scene, camera);
            const dataURL = renderer.domElement.toDataURL("image/png");
            document.getElementById('screenshot-img').src = dataURL;
            document.getElementById('modal-overlay').style.display = 'flex';
            camera.position.copy(currentCamPos);
            orbit.target.copy(currentTarget);
            camera.updateProjectionMatrix();
            orbit.update();
            gizmo.visible = true; gridHelper.visible = true; plane.visible = true;
            if (!isPlacing) botones.forEach(b => b.visible = true);
        };

        document.getElementById('btn-close-modal').onclick = () => {
            document.getElementById('modal-overlay').style.display = 'none';
        };

        document.getElementById('btn-export-dummy').onclick = () => { };

        window.addEventListener('keydown', (e) => { if ((e.ctrlKey || e.metaKey) && e.key === 'z') document.getElementById('btn-undo').click(); });
        function onResize() { camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth, window.innerHeight); }
        function animate() { requestAnimationFrame(animate); orbit.update(); renderer.render(scene, camera); }
    </script>
</body>
</html>